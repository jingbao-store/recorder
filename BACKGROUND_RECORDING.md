# 后台录制功能说明

## ✨ 新功能：自动后台录制

应用现在支持**在后台持续录制**，录制开始后会自动最小化到后台，这样你就可以：

### 使用流程

1. **打开应用并授予权限**
   - 摄像头权限
   - 麦克风权限  
   - 通知权限
   - 屏幕录制权限（录制时请求）

2. **开始录制**
   - 点击红色圆形录制按钮
   - 授予屏幕录制权限
   - ✅ **应用自动最小化到后台**

3. **使用其他应用**
   - 返回主屏幕
   - 打开任何应用（微信、浏览器、游戏等）
   - **所有操作都会被录制**
   - 摄像头画面会实时显示在右下角（录制到视频中）

4. **停止录制**
   - **方式 1**：下拉通知栏，点击「停止录制」按钮
   - **方式 2**：重新打开 AR Recorder 应用，点击停止按钮

5. **查看录制的视频**
   - 视频自动保存到：`/sdcard/Movies/ARRecorder/`

## 📱 通知栏控制

录制进行时，通知栏会显示：
```
┌─────────────────────────────┐
│ AR 录制器                    │
│ 正在录制... 00:15            │
│ [停止录制]                   │
└─────────────────────────────┘
```

- 通知显示录制时长（每秒更新）
- 点击「停止录制」按钮即可结束录制
- 点击通知本身可重新打开应用

## 🎯 典型使用场景

### 场景 1：录制应用操作教程
```
1. 启动 AR Recorder
2. 开始录制 → 应用自动后台
3. 打开要演示的应用（如微信）
4. 执行操作（发消息、视频通话等）
5. 通知栏停止录制
```

### 场景 2：录制游戏过程
```
1. 启动 AR Recorder
2. 开始录制 → 应用自动后台
3. 打开游戏应用
4. 游戏画面 + 你的表情都会被录制
5. 游戏结束后通知栏停止
```

### 场景 3：录制 AR 体验
```
1. 启动 AR Recorder
2. 开始录制 → 应用自动后台
3. 使用 Rokid 眼镜的 AR 功能
4. 屏幕显示的 AR 内容 + 摄像头拍到的真实场景
5. 完美记录 AR 体验
```

## 🔧 技术实现

### 架构改进

**之前的版本**：
- 录制逻辑在 Activity 中
- 应用切换到后台可能中断录制
- 依赖 Activity 生命周期

**新版本**：
- 录制逻辑完全在 Service 中
- Service 独立运行，不受 Activity 影响
- 前台服务确保系统不杀死进程

### 关键组件

```
RecordingService (Service)
├── 管理整个录制生命周期
├── 持有所有录制组件
│   ├── ScreenRecorder (屏幕录制)
│   ├── CameraRecorder (摄像头)
│   ├── AudioRecorder (麦克风)
│   ├── VideoComposer (OpenGL合成)
│   └── MediaEncoder (编码器)
├── 渲染循环（30fps）
├── 定时器更新通知
└── 广播状态给 UI

RecorderViewModelSimple (ViewModel)
├── 启动/停止 Service
├── 监听广播接收状态
└── 更新 UI 显示

RecorderScreenSimple (UI)
├── 显示录制状态
├── 权限请求
├── 录制开始后自动最小化
└── 实时显示录制时长
```

### 数据流向

```
┌─────────────┐
│    UI       │ 点击开始录制
│  (Activity) │─────────────┐
└─────────────┘             │
       ↑                    ↓
       │              ┌──────────────┐
    广播更新           │   Service    │
       │              │  (后台运行)   │
       │              └──────────────┘
       │                     │
       │              ┌──────┴──────┐
       │              │   录制组件   │
       │              │  - 屏幕      │
       │              │  - 摄像头    │
       │              │  - 音频      │
       │              │  - 合成      │
       │              │  - 编码      │
       │              └─────────────┘
       │                     │
       └──────────────────── ↓
                        视频文件
```

## 🔒 权限和安全

### 必需权限
- `CAMERA` - 录制摄像头
- `RECORD_AUDIO` - 录制麦克风
- `FOREGROUND_SERVICE` - 前台服务
- `FOREGROUND_SERVICE_MEDIA_PROJECTION` - 屏幕录制前台服务
- `POST_NOTIFICATIONS` - 显示通知

### 隐私保护
- 录制过程中通知栏会持续显示「正在录制」
- 用户随时可以看到录制状态
- 随时可通过通知栏停止录制
- 不会偷偷在后台录制

## ⚡ 性能优化

### Service 中的优化
1. **硬件编码**：使用 MediaCodec 硬件加速
2. **OpenGL 离屏渲染**：高效的视频合成
3. **帧率控制**：精确的 30fps 控制
4. **音视频同步**：统一时间基准

### 电量和发热
- 录制是资源密集型操作
- 建议录制时长不超过 30 分钟
- 注意设备发热情况
- 必要时可降低分辨率/帧率

## 📊 查看日志

### 实时查看录制状态
```bash
adb -s 1901092534000358 logcat -s RecordingService:D RecorderViewModelSimple:D
```

### 查看详细日志
```bash
adb -s 1901092534000358 logcat | grep -E "(RecordingService|VideoComposer|MediaEncoder|ScreenRecorder|CameraRecorder)"
```

## 🐛 故障排除

### 问题 1：应用没有自动最小化
**原因**：权限问题或系统限制  
**解决**：手动按 Home 键返回主屏幕，录制会继续

### 问题 2：通知栏没有显示
**原因**：通知权限未授予  
**解决**：在应用设置中授予通知权限

### 问题 3：录制中途停止
**原因**：系统资源不足或设备过热  
**解决**：
- 关闭其他应用释放内存
- 让设备冷却后再试
- 降低录制质量（修改 RecordingConfig）

### 问题 4：视频中摄像头画面不显示
**原因**：摄像头初始化失败  
**解决**：
- 确认摄像头权限已授予
- 重启应用重试
- 查看日志：`adb logcat -s CameraRecorder:D`

### 问题 5：音频没有录制
**原因**：麦克风权限或音频录制失败  
**解决**：
- 确认麦克风权限已授予
- 检查是否有其他应用占用麦克风
- 查看日志：`adb logcat -s AudioRecorder:D`

## 💡 使用技巧

### 技巧 1：提前准备
- 在开始重要录制前，先做一次短时间测试
- 确认画中画效果符合预期
- 检查视频质量和音量

### 技巧 2：合理规划录制内容
- 录制前规划好要演示的内容
- 避免录制敏感信息（密码、私人对话等）
- 录制结束记得及时停止

### 技巧 3：优化视频质量
- 在光线充足的环境下录制
- 保持设备稳定（AR 眼镜佩戴牢固）
- 说话清晰（麦克风录音）

## 📸 录制效果

录制的视频包含：

1. **主画面（全屏）**
   - AR 眼镜显示的所有内容
   - 应用界面、游戏画面、AR 叠加层
   - 屏幕上的一切

2. **画中画（右下角）**
   - 摄像头拍摄的真实场景
   - 你的表情、手势
   - 周围环境

3. **音频**
   - 麦克风录制的声音
   - 你的讲解、对话

## 🎉 完成！

现在你的 AR 录制器已经支持完整的后台录制功能了！

- ✅ 自动最小化到后台
- ✅ 通知栏控制
- ✅ 独立运行不受影响
- ✅ 可录制任何应用

尽情使用吧！📹

