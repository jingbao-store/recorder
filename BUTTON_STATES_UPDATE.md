# 按钮状态设计更新

## 🎨 设计规范

根据 Rokid 官方设计规范，按钮需要三种视觉状态：

### 状态定义

| 状态 | 描边透明度 | 触发条件 | 说明 |
|------|-----------|---------|------|
| **常态** | 40% | 无焦点，未按下 | 按钮默认状态 |
| **选中** | 80% | 有焦点，未按下 | 用户通过方向键导航到该按钮 |
| **按下** | 100% | 有焦点，按下确认键 | 用户按下 ENTER/确认键的瞬间 |

### 视觉示例

```
常态（40%）：
┌────────────────────┐
│ ░░░░░░░░░░░░░░░░░░ │  ← 淡绿色边框（40% 透明度）
│ │  开始录制      │ │
│ ░░░░░░░░░░░░░░░░░░ │
└────────────────────┘

选中（80%）：
┌────────────────────┐
│ ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓ │  ← 亮绿色边框（80% 透明度）
│ │  开始录制      │ │
│ ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓ │
└────────────────────┘

按下（100%）：
┌────────────────────┐
│ ████████████████████ │  ← 完全不透明绿色边框（100%）
│ │  开始录制      │ │
│ ████████████████████ │
└────────────────────┘
```

---

## 🔧 技术实现

### 1. 状态管理

使用 Compose 的状态机制：

```kotlin
var isFocused by remember { mutableStateOf(false) }  // 焦点状态
var isPressed by remember { mutableStateOf(false) }  // 按下状态

// 根据状态计算描边透明度
val borderAlpha = when {
    isPressed -> 1.0f        // 按下：100%
    isFocused -> 0.8f        // 选中：80%
    else -> 0.4f             // 常态：40%
}
```

### 2. 边框绘制

使用动态透明度绘制边框：

```kotlin
Box(
    modifier = Modifier
        .border(
            width = 2.dp,
            color = RokidGreen.copy(alpha = borderAlpha),  // 动态透明度
            shape = RoundedCornerShape(12.dp)
        )
)
```

### 3. 按键事件处理

精确处理 KeyDown 和 KeyUp 事件：

```kotlin
.onKeyEvent { keyEvent ->
    when (keyEvent.key) {
        Key.Enter, Key.DirectionCenter -> {
            if (keyEvent.type == KeyEventType.KeyDown) {
                isPressed = true      // 按下时设置为 true
                true
            } else if (keyEvent.type == KeyEventType.KeyUp) {
                isPressed = false     // 释放时设置为 false
                if (isFocused) {
                    onClick()         // 在释放时触发点击
                }
                true
            } else {
                false
            }
        }
        else -> false
    }
}
```

---

## 🐛 修复的问题

### 问题 1：确认键无法触发按钮

**症状**：
- 用户按下 ENTER 键，按钮没有响应
- 点击事件未被触发

**原因**：
- Button 的 onClick 和 Box 的 onKeyEvent 同时存在，产生冲突
- onKeyEvent 捕获了按键事件，但没有正确处理

**解决方案**：
```kotlin
// ❌ 之前的实现（有冲突）
Button(
    onClick = onClick,  // 永远不会被触发
    ...
)

// ✅ 现在的实现（正确）
Button(
    onClick = { /* 由 onKeyEvent 处理 */ },  // 禁用 Button 的点击
    ...
)

// onKeyEvent 完全接管按键处理
.onKeyEvent { keyEvent ->
    if (keyEvent.type == KeyEventType.KeyUp) {
        if (isFocused) {
            onClick()  // 在这里触发
        }
    }
}
```

---

### 问题 2：按下状态无视觉反馈

**症状**：
- 按下 ENTER 键时，按钮视觉上无变化
- 用户不知道是否已按下

**原因**：
- 之前只有焦点状态（选中），没有按下状态
- 边框透明度只有两种：有焦点（100%）、无焦点（无边框）

**解决方案**：
```kotlin
// ✅ 添加按下状态
var isPressed by remember { mutableStateOf(false) }

// ✅ 三种透明度
val borderAlpha = when {
    isPressed -> 1.0f        // 按下最亮
    isFocused -> 0.8f        // 选中次亮
    else -> 0.4f             // 常态最暗
}

// ✅ 在 KeyDown 时设置按下状态
if (keyEvent.type == KeyEventType.KeyDown) {
    isPressed = true
}
```

---

## 📋 更新的组件

### 1. RokidRecordButton（单按钮）

**用途**：
- "开始录制"按钮
- "停止录制"按钮（录制时）

**状态**：
- ✅ 常态（40%）
- ✅ 选中（80%）
- ✅ 按下（100%）

**代码位置**：
```
/app/src/main/java/com/jingbao/recorder/ui/RokidRecorderScreen.kt
第 263-341 行
```

---

### 2. RokidPermissionButton（权限按钮）

**用途**：
- "授予权限"按钮

**状态**：
- ✅ 常态（40%）
- ✅ 选中（80%）
- ✅ 按下（100%）

**代码位置**：
```
/app/src/main/java/com/jingbao/recorder/ui/RokidRecorderScreen.kt
第 343-433 行
```

---

### 3. RokidNavigableButton（可导航按钮）

**用途**：
- "后台运行"按钮
- "停止录制"按钮（双按钮模式）

**状态**：
- ✅ 常态（40%）
- ✅ 选中（80%）
- ✅ 按下（100%）
- ✅ 支持方向键导航（↑↓）

**代码位置**：
```
/app/src/main/java/com/jingbao/recorder/ui/RokidRecorderScreen.kt
第 495-588 行
```

---

## 🎯 用户体验改进

### 改进前

| 操作 | 视觉反馈 | 用户感受 |
|------|---------|---------|
| 导航到按钮 | 突然出现边框（100%） | 反差大，不够流畅 |
| 按下 ENTER | 无变化 | 不知道是否按下 |
| 释放 ENTER | 无变化 | 不知道是否触发 |
| 失去焦点 | 边框突然消失 | 反差大 |

### 改进后

| 操作 | 视觉反馈 | 用户感受 |
|------|---------|---------|
| 导航到按钮 | 边框从 40% → 80% | 渐进式，流畅自然 ✅ |
| 按下 ENTER | 边框从 80% → 100% | 清晰反馈，知道已按下 ✅ |
| 释放 ENTER | 边框从 100% → 80% | 清晰反馈，知道已释放 ✅ |
| 失去焦点 | 边框从 80% → 40% | 渐进式，不会突然消失 ✅ |

---

## 🔍 状态转换流程

### 完整状态机

```
┌─────────┐
│  常态   │  40% 透明度
│ (无焦点) │
└────┬────┘
     │
     │ 用户导航到按钮（获得焦点）
     ▼
┌─────────┐
│  选中   │  80% 透明度
│ (有焦点) │
└────┬────┘
     │
     │ 用户按下 ENTER 键（KeyDown）
     ▼
┌─────────┐
│  按下   │  100% 透明度
│(焦点+按下)│
└────┬────┘
     │
     │ 用户释放 ENTER 键（KeyUp）
     ▼
┌─────────┐
│  选中   │  80% 透明度 → 触发 onClick()
│ (有焦点) │
└────┬────┘
     │
     │ 用户导航离开（失去焦点）
     ▼
┌─────────┐
│  常态   │  40% 透明度
│ (无焦点) │
└─────────┘
```

---

## 📊 对比表

### 边框透明度

| 状态 | 更新前 | 更新后 | 改进 |
|------|--------|--------|------|
| 常态 | ❌ 无边框 | ✅ 40% | 始终可见 |
| 选中 | ⚠️ 100%（过亮） | ✅ 80% | 适中 |
| 按下 | ❌ 无变化 | ✅ 100% | 最亮 |

### 按键处理

| 事件 | 更新前 | 更新后 | 改进 |
|------|--------|--------|------|
| KeyDown | ❌ 忽略 | ✅ 设置按下状态 | 视觉反馈 |
| KeyUp | ⚠️ 可能触发，可能不触发 | ✅ 必定触发 | 可靠 |
| 焦点丢失时按下 | ❌ 可能误触发 | ✅ 检查焦点，不会误触发 | 安全 |

---

## 🧪 测试建议

### 测试场景 1：基本操作

1. 启动应用
2. 观察"开始录制"按钮边框（应该是淡绿色，40%）
3. 按 ↓ 键（如果有其他按钮）
4. 按 ↑ 键回到"开始录制"
5. 观察边框变化（应该变亮到 80%）

**预期结果**：
- ✅ 边框从 40% 变为 80%

---

### 测试场景 2：按下反馈

1. 聚焦在"开始录制"按钮（边框 80%）
2. **按住 ENTER 键不放**
3. 观察边框变化（应该变为 100%，最亮）
4. **释放 ENTER 键**
5. 观察边框变化（应该回到 80%）
6. 确认录制开始

**预期结果**：
- ✅ 按下时：80% → 100%
- ✅ 释放时：100% → 80%
- ✅ 录制成功启动

---

### 测试场景 3：双按钮导航

1. 开始录制（进入录制状态）
2. 观察两个按钮：
   - "后台运行"（焦点，80%）
   - "停止录制"（无焦点，40%）
3. 按 ↓ 键切换到"停止录制"
4. 观察边框变化：
   - "后台运行"：80% → 40%
   - "停止录制"：40% → 80%
5. **按住 ENTER 键**
6. 观察"停止录制"边框变为 100%

**预期结果**：
- ✅ 焦点切换时透明度正确
- ✅ 按下时透明度达到 100%

---

### 测试场景 4：权限请求

1. 首次启动应用（需要权限）
2. 观察"授予权限"按钮（焦点，80%）
3. 按下 ENTER 键
4. 观察边框变化：80% → 100% → 80%
5. 确认权限弹窗出现

**预期结果**：
- ✅ 按下反馈正确
- ✅ 权限弹窗成功触发

---

## 🎨 颜色规范

### Rokid 绿色

```kotlin
val RokidGreen = Color(0xFF40FF5E)
```

### 不同透明度的视觉效果

| 透明度 | 十六进制 | 视觉效果 | 用途 |
|--------|---------|---------|------|
| 100% | `#40FF5E` | 完全不透明，最亮 | 按下状态 |
| 80% | `#40FF5ECC` | 半透明，较亮 | 选中状态 |
| 40% | `#40FF5E66` | 半透明，较暗 | 常态状态 |

### 在黑色背景上的效果

```
黑色背景 (#000000)：
┌──────────────────┐
│ 40%：淡淡的绿色边框 │  ← 可见但不突出
│ 80%：明显的绿色边框 │  ← 清晰表示焦点
│ 100%：鲜艳的绿色边框 │ ← 最醒目，表示按下
└──────────────────┘
```

---

## ✅ 更新总结

### 设计改进

1. ✅ **三种状态透明度**：40% / 80% / 100%
2. ✅ **平滑过渡**：状态切换更自然
3. ✅ **清晰反馈**：用户明确知道当前状态
4. ✅ **符合规范**：遵循 Rokid 官方设计规范

### 功能修复

1. ✅ **确认键响应**：修复无法触发按钮的问题
2. ✅ **按下反馈**：添加按下状态的视觉反馈
3. ✅ **事件处理**：KeyDown/KeyUp 精确处理
4. ✅ **焦点检查**：避免失焦时误触发

### 代码质量

1. ✅ **状态管理清晰**：使用 Compose 状态机制
2. ✅ **事件处理完善**：区分 KeyDown 和 KeyUp
3. ✅ **视觉效果统一**：所有按钮使用相同逻辑
4. ✅ **注释完整**：代码易于理解和维护

---

## 📝 注意事项

### 1. 透明度层次

- **不要**将常态设置为 0%（完全透明）
- **原因**：用户需要看到所有可交互元素
- **正确做法**：常态 40%，始终可见

### 2. 按键事件

- **必须**区分 KeyDown 和 KeyUp
- **原因**：提供精确的按下/释放反馈
- **正确做法**：KeyDown 设置状态，KeyUp 触发动作

### 3. 焦点检查

- **必须**在触发 onClick 前检查焦点
- **原因**：避免失焦时误操作
- **正确做法**：`if (isFocused) { onClick() }`

---

**按钮状态更新完成！** 🎉

现在所有按钮都符合 Rokid 设计规范，提供清晰的视觉反馈！

