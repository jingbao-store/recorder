# 后台录制问题修复

## 问题 1：相机在后台被关闭

应用进入后台后，相机被关闭，录制停止。

### 原因

`RecordingService` 使用了 `ProcessLifecycleOwner`，当应用进入后台时，它的生命周期变成 `STOPPED`，导致 CameraX 自动关闭相机。

### 解决方案

创建了自定义的 `ServiceLifecycleOwner`，其生命周期完全由 Service 控制，不受应用前后台切换影响。

## 问题 2：回到应用时 UI 状态错误

回到应用后，UI 显示"待机"状态，但录制实际还在进行。

### 原因

ViewModel 被清理后，新创建的 ViewModel 状态为默认的 `IDLE`，Service 不会主动发送当前状态。

### 解决方案

在 ViewModel 注册广播接收器后，检查 Service 是否正在运行，如果是则恢复 UI 状态。

---

## 修改的文件

### 1. 新增文件

**`app/src/main/java/com/jingbao/recorder/lifecycle/ServiceLifecycleOwner.kt`**
   - 自定义 LifecycleOwner 实现
   - 提供 `start()` 和 `stop()` 方法控制生命周期

### 2. 修改文件

**`app/src/main/java/com/jingbao/recorder/service/RecordingService.kt`**
   - 添加 `serviceLifecycleOwner` 实例
   - 在 `onCreate()` 中启动生命周期
   - 在 `onDestroy()` 中停止生命周期
   - 将所有 `ProcessLifecycleOwner.get()` 替换为 `serviceLifecycleOwner`

**`app/src/main/java/com/jingbao/recorder/viewmodel/RecorderViewModelSimple.kt`**
   - 添加 `isRecordingServiceRunning()` 方法
   - 在 `registerReceivers()` 中检查并恢复状态

## 测试步骤

### 快速测试

```bash
cd /Users/nicholasmac/Documents/code/recorder

# 运行自动化测试脚本
./test-background-recording.sh
```

### 手动测试

```bash
# 1. 编译安装
./gradlew assembleDebug
adb install -r app/build/outputs/apk/debug/app-debug.apk

# 2. 监控日志
adb logcat -s RecordingService:D CameraRecorder:D Camera2CameraImpl:D

# 3. 测试步骤
# - 打开应用
# - 开始录制
# - 按 Home 键进入后台
# - 等待 30 秒
# - 停止录制
# - 检查视频文件

# 4. 检查视频
adb shell ls -lh /sdcard/Movies/Camera/
```

## 验证要点

修复成功的标志：

✅ **日志中应该看到：**
- `ServiceLifecycleOwner started, state: RESUMED`
- 应用进入后台后**没有**看到 `Closing camera`
- 应用进入后台后**没有**看到 `Use cases DETACHED`

❌ **日志中不应该看到：**
- `Camera2CameraImpl: Transitioning camera internal state: OPENED --> CLOSING`
- `Use cases [...] now DETACHED for camera`

✅ **视频文件：**
- 视频文件应该包含整个后台录制的时长
- 视频质量正常，没有中断

## 技术原理

### ProcessLifecycleOwner vs ServiceLifecycleOwner

| 特性 | ProcessLifecycleOwner | ServiceLifecycleOwner |
|------|----------------------|----------------------|
| 生命周期绑定 | 整个应用进程 | RecordingService |
| 应用后台 | 变为 STOPPED | 保持 RESUMED |
| 相机状态 | 被关闭 ❌ | 保持运行 ✅ |
| 控制方式 | 自动 | 手动控制 |

### CameraX 生命周期管理

```kotlin
cameraProvider.bindToLifecycle(
    lifecycleOwner,  // 监听这个 LifecycleOwner 的状态
    cameraSelector,
    preview
)

// CameraX 的行为：
// lifecycleOwner.state == RESUMED  → 相机运行
// lifecycleOwner.state == STOPPED  → 相机关闭 ⚠️
// lifecycleOwner.state == DESTROYED → 资源释放
```

使用 `ServiceLifecycleOwner` 后，只有当 Service 真正销毁时，相机才会被关闭。

## 相关文档

- 📄 [BACKGROUND_RECORDING_FIX.md](./BACKGROUND_RECORDING_FIX.md) - 详细的技术说明
- 📄 [BACKGROUND_RECORDING.md](./BACKGROUND_RECORDING.md) - 后台录制功能文档
- 🧪 [test-background-recording.sh](./test-background-recording.sh) - 自动化测试脚本

## 结果

✅ **相机在后台保持运行**（ServiceLifecycleOwner 修复）  
✅ **录制不受应用前后台切换影响**  
✅ **返回应用时 UI 状态正确**（状态恢复修复）  
✅ **Service 完全控制生命周期**  
✅ **符合 CameraX 设计原则**

**两个问题都已修复！现在可以完整体验后台录制功能了。** 📹

## 相关文档

- 📄 [STATE_RESTORE_FIX.md](./STATE_RESTORE_FIX.md) - UI 状态恢复详细说明
- 📄 [BACKGROUND_RECORDING_FIX.md](./BACKGROUND_RECORDING_FIX.md) - 相机后台运行详细说明
- 📄 [BACKGROUND_RECORDING.md](./BACKGROUND_RECORDING.md) - 后台录制功能介绍

